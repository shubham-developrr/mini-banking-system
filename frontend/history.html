<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#2563eb">
    <title>Transaction History - SecureBank</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS - New Design System -->
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    
    <!-- Navigation Bar -->
    <nav class="navbar navbar-app">
        <div class="container">
            <div class="navbar-content">
                <a href="dashboard.html" class="btn btn-icon-only">
                    <i class="fas fa-arrow-left"></i>
                </a>
                
                <h1 class="navbar-title">Transaction History</h1>
                
                <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">
                    <span class="theme-toggle-slider"></span>
                    <span class="theme-toggle-icon">
                        <i class="fas fa-sun"></i>
                    </span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="dashboard-main">
        <div class="container">
            <!-- Filter Section -->
            <div class="card filter-card">
                <div class="filter-header">
                    <h3>Filter Transactions</h3>
                </div>
                <div class="filter-options">
                    <button class="btn btn-sm btn-outline filter-btn active" data-filter="all">
                        <i class="fas fa-list"></i>
                        <span>All</span>
                    </button>
                    <button class="btn btn-sm btn-outline filter-btn" data-filter="deposit">
                        <i class="fas fa-arrow-down"></i>
                        <span>Deposits</span>
                    </button>
                    <button class="btn btn-sm btn-outline filter-btn" data-filter="withdraw">
                        <i class="fas fa-arrow-up"></i>
                        <span>Withdrawals</span>
                    </button>
                    <button class="btn btn-sm btn-outline filter-btn" data-filter="transfer">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Transfers</span>
                    </button>
                </div>
            </div>
            
            <!-- Transactions List -->
            <div class="section-header">
                <h2>All Transactions</h2>
                <div id="transactionCount" class="badge">0</div>
            </div>
            
            <div class="card">
                <div class="transaction-list" id="transactionsList">
                    <!-- Loading State -->
                    <div class="loading-state" id="loadingState">
                        <div class="skeleton-loader">
                            <div class="skeleton-line"></div>
                            <div class="skeleton-line"></div>
                            <div class="skeleton-line"></div>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <div class="empty-state-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <h3>No transactions found</h3>
                        <p>Your transactions will appear here</p>
                        <a href="dashboard.html" class="btn btn-primary">
                            <i class="fas fa-home"></i>
                            <span>Go to Dashboard</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="bottom-nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="deposit.html" class="bottom-nav-item">
            <i class="fas fa-plus-circle"></i>
            <span>Deposit</span>
        </a>
        <a href="transfer.html" class="bottom-nav-item">
            <i class="fas fa-exchange-alt"></i>
            <span>Transfer</span>
        </a>
        <a href="history.html" class="bottom-nav-item active">
            <i class="fas fa-history"></i>
            <span>History</span>
        </a>
    </nav>

    <!-- Custom JavaScript -->
    <script src="js/theme.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/history.js"></script>
    
    <script>
        // Initialize theme
        if (window.themeManager) {
            window.themeManager.init();
        }
        
        let allTransactions = [];
        let currentFilter = 'all';
        
        // Filter button handlers
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update filter
                currentFilter = this.getAttribute('data-filter');
                
                // Apply filter
                filterTransactions(currentFilter);
                
                // Haptic feedback
                if (window.triggerHaptic) {
                    window.triggerHaptic('light');
                }
            });
        });
        
        function filterTransactions(filter) {
            const transactionsList = document.getElementById('transactionsList');
            const transactionCount = document.getElementById('transactionCount');
            const emptyState = document.getElementById('emptyState');
            
            let filtered = allTransactions;
            
            if (filter !== 'all') {
                filtered = allTransactions.filter(t => t.transaction_type.toLowerCase() === filter);
            }
            
            // Update count
            transactionCount.textContent = filtered.length;
            
            // Clear list
            transactionsList.innerHTML = '';
            
            if (filtered.length === 0) {
                emptyState.style.display = 'flex';
                transactionsList.appendChild(emptyState);
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Render transactions
            filtered.forEach(transaction => {
                const item = createTransactionItem(transaction);
                transactionsList.appendChild(item);
            });
        }
        
        function createTransactionItem(transaction) {
            const item = document.createElement('div');
            item.className = 'transaction-item';
            
            const type = transaction.transaction_type.toLowerCase();
            let iconClass = 'transaction-item-icon';
            let icon = '';
            
            if (type === 'deposit') {
                iconClass += ' transaction-item-icon-success';
                icon = 'fa-arrow-down';
            } else if (type === 'withdraw') {
                iconClass += ' transaction-item-icon-danger';
                icon = 'fa-arrow-up';
            } else if (type === 'transfer') {
                iconClass += ' transaction-item-icon-primary';
                icon = 'fa-exchange-alt';
            }
            
            const date = new Date(transaction.timestamp);
            const formattedDate = date.toLocaleDateString('en-IN', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
            const formattedTime = date.toLocaleTimeString('en-IN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            item.innerHTML = `
                <div class="${iconClass}">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="transaction-item-content">
                    <div class="transaction-item-title">${transaction.transaction_type}</div>
                    <div class="transaction-item-meta">
                        <span><i class="fas fa-calendar"></i> ${formattedDate}</span>
                        <span><i class="fas fa-clock"></i> ${formattedTime}</span>
                    </div>
                </div>
                <div class="transaction-item-amount ${type === 'deposit' ? 'transaction-amount-success' : 'transaction-amount-danger'}">
                    ${type === 'deposit' ? '+' : '-'}â‚¹${parseFloat(transaction.amount).toFixed(2)}
                </div>
            `;
            
            return item;
        }
        
        // Load transactions on page load
        window.addEventListener('DOMContentLoaded', async function() {
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const transactionsList = document.getElementById('transactionsList');
            
            try {
                // Check if loadTransactions function exists (from history.js)
                if (typeof loadTransactions === 'function') {
                    await loadTransactions();
                    
                    // After loading, the history.js should populate the list
                    // We'll wait a bit and check
                    setTimeout(() => {
                        loadingState.style.display = 'none';
                        
                        // Check if transactions were loaded
                        const items = transactionsList.querySelectorAll('.transaction-item');
                        if (items.length === 0) {
                            emptyState.style.display = 'flex';
                            transactionsList.appendChild(emptyState);
                        }
                    }, 500);
                } else {
                    // Fallback: load from API directly
                    loadingState.style.display = 'none';
                    emptyState.style.display = 'flex';
                    transactionsList.appendChild(emptyState);
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                loadingState.style.display = 'none';
                emptyState.style.display = 'flex';
                transactionsList.appendChild(emptyState);
            }
        });
        
        // Pull to refresh on mobile
        if (window.PullToRefresh && window.isMobileDevice()) {
            new PullToRefresh(document.body, async () => {
                if (typeof loadTransactions === 'function') {
                    await loadTransactions();
                }
            });
        }
    </script>
</body>
</html>
